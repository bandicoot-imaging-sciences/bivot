import{UniformsUtils as e,UniformsLib as t,Vector2 as n,Vector3 as o,Scene as i,Color as a,AmbientLight as s,PerspectiveCamera as r,Math as l,Mesh as u,LoadingManager as c,RGBFormat as h,WebGLRenderer as f,Group as m,RectAreaLight as d,PointLight as g,ShaderMaterial as p,PlaneBufferGeometry as v,TextureLoader as y,LinearFilter as w,LinearMipMapLinearFilter as b,NearestFilter as S}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/build/three.module.js";import{OrbitControls as P}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/controls/OrbitControls.js";import{EXRLoader as x}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/loaders/EXRLoader.js";import{OBJLoader as L}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/loaders/OBJLoader.js";import{WEBGL as M}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/WebGL.js";import{EffectComposer as C}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/postprocessing/EffectComposer.js";import{RenderPass as D}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/postprocessing/RenderPass.js";import{ShaderPass as T}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/postprocessing/ShaderPass.js";import{UnrealBloomPass as R}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/postprocessing/UnrealBloomPass.js";import{AdaptiveToneMappingPass as E}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/postprocessing/AdaptiveToneMappingPass.js";import{FXAAShader as _}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/shaders/FXAAShader.js";import{GammaCorrectionShader as j}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/shaders/GammaCorrectionShader.js";import{RectAreaLightUniformsLib as F}from"https://cdn.jsdelivr.net/gh/bandicoot-imaging-sciences/three.js@rectarea-halffloat/examples/jsm/lights/RectAreaLightUniformsLib.js";function O(){return(O=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}function A(e,t){return t||(t=e.slice(0)),e.raw=t,e}function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function k(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return I(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?I(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function B(){var e=A(["\n    uniform sampler2D diffuseMap;\n    // Defined in <normalmap_pars_fragment>\n    // uniform sampler2D normalMap;\n    uniform sampler2D specularMap;\n\n    uniform sampler2D diffuseMapLow;\n    uniform sampler2D normalMapLow;\n    uniform sampler2D specularMapLow;\n\n    uniform float uExposure;\n    uniform float uBrightness;\n    uniform float uContrast;\n    uniform float uDiffuse;\n    uniform float uSpecular;\n    uniform float uRoughness;\n    uniform bool  uTint;\n    uniform bool  uFresnel;\n    uniform bool  uThreeJsShader;\n\n    uniform int   uBrdfModel;\n    uniform float uBrdfVersion;\n    uniform bool  uDual8Bit;\n    uniform bool  uLoadExr;\n\n    varying vec3 vNormal;\n    varying vec3 vTangent;\n    varying vec3 vBitangent;\n    varying vec2 vUv;\n    varying vec3 vViewPosition;\n\n    float pi = 3.14159265359;\n\n    #include <common>\n    #include <bsdfs>\n    #include <packing>\n    #include <lights_pars_begin>\n    #include <normalmap_pars_fragment>\n    #include <lights_physical_pars_fragment>\n\n    float calcLightAttenuation(float lightDistance, float cutoffDistance, float decayExponent) {\n      if (decayExponent > 0.0) {\n        // The common ShaderChunk includes: #define saturate(a) clamp( a, 0.0, 1.0 )\n        return pow(saturate(-lightDistance/cutoffDistance + 1.0), decayExponent);\n      }\n      return 1.0;\n    }\n\n    float DisneySpecular(float specular, float roughness, float ndh, float s) {\n      // TODO: Add episilon to fragile denominators.\n      float r4 = pow(roughness, 4.0);\n      float k = 1.0 - r4;\n      float c = (1.0/(s*PI))*((1.0/r4 + (1.0/(2.0*sqrt(k))*log((sqrt(k) + k)/(sqrt(k) - k)))));\n      float denom = pow((1.0 + (r4 - 1.0)*pow(ndh, 2.0)), 2.0);\n      return (specular)/(c*denom);\n    }\n\n    float MRSpecular(float roughness, float ndh, float ndl, float ndv) {\n      float r2 = roughness * roughness;\n\n      // Substance Designer uses a different expression for visibility:\n      //   float k = r2 / 2.0;\n      //   float visibility = 1.0 / (4.0 * (ndl * (1.0 - k) + k) * (ndv * (1.0 - k) + k));\n\n      // Three.js\n      //   The following code should be equivalent to calling:\n      //     return G_GGX_Smith(r2, ndl, ndv) * D_GGX(r2, ndh);\n      float k = r2 * r2;\n      float gl = ndl + sqrt(ndv*ndv * (1.0 - k) + k);\n      float gv = ndv + sqrt(ndl*ndl * (1.0 - k) + k);\n      float visibility = 1.0 / (gl * gv);\n      //float visibility = 0.25;\n      float t = r2 / (1.0 + (r2 * r2 - 1.0) * ndh*ndh);\n      return visibility * t*t / pi;\n    }\n\n\n    void main() {\n      vec4 diffuseSurface = texture2D(diffuseMap, vUv);\n      vec3 normalSurface = texture2D(normalMap, vUv).xyz;\n      vec4 specularTexel = texture2D(specularMap, vUv);\n\n      if (uDual8Bit) {\n        vec4 diffuseSurfaceLow = texture2D(diffuseMapLow, vUv) / 256.0;\n        vec3 normalSurfaceLow = texture2D(normalMapLow, vUv).xyz / 256.0;\n        vec4 specularTexelLow = texture2D(specularMapLow, vUv) / 256.0;\n\n        diffuseSurface = diffuseSurface + diffuseSurfaceLow;\n        normalSurface = normalSurface + normalSurfaceLow;\n        specularTexel = specularTexel + specularTexelLow;\n      }\n\n      float s = 1.0;\n      float white_L = 1.0;\n      float specularSurface = 0.0;\n      float roughnessSurface = 0.0;\n      float tintSurface = 0.0;\n      float metallicSurface = 0.0;\n\n      if (uBrdfModel == 1) {\n        // (M/R model)\n        white_L = 16383.0;\n        roughnessSurface = specularTexel.r;\n        metallicSurface = specularTexel.g;\n      } else {\n        // uBrdfModel == 0 (BIS model)\n        specularSurface = specularTexel.r;\n        roughnessSurface = specularTexel.g;\n        if (uTint && uBrdfVersion >= 2.0) {\n          tintSurface = specularTexel.b;\n        }\n        if (uBrdfVersion >= 2.0) {\n          s = 65535.0*0.01;\n        }\n\n        if (uLoadExr) {\n          if (uBrdfVersion == 3.0) {\n            diffuseSurface *= 16383.0;\n          }\n        } else {\n          diffuseSurface *= 65535.0;\n        }\n      }\n\n      if (uThreeJsShader && uBrdfModel == 1) {\n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n        vec4 diffuseColor = diffuseSurface;\n        float metalnessFactor = metallicSurface;\n        float roughnessFactor = uRoughness * roughnessSurface;\n        #include <normal_fragment_begin>\n        #include <normal_fragment_maps>\n        #include <lights_physical_fragment>\n        #include <lights_fragment_begin>\n        #include <lights_fragment_maps>\n        #include <lights_fragment_end>\n\n        // Ambient light is calculated automatically as part of reflectedLight.indirectDiffuse\n        //vec3 ambientFactor = diffuseSurface.rgb * ambientLightColor;\n        vec3 diffuseFactor = uDiffuse * (reflectedLight.directDiffuse + reflectedLight.indirectDiffuse);\n        vec3 specularFactor = uSpecular * (reflectedLight.directSpecular + reflectedLight.indirectSpecular);\n        vec3 outgoingLight = white_L * uExposure * (diffuseFactor + specularFactor);\n        gl_FragColor = vec4((uContrast * (outgoingLight * 2.0 - 1.0) + 0.5) + 2.0 * uBrightness - 1.0, diffuseColor.a);\n      } else {\n        vec3 macroNormal = normalize(vNormal);\n        //vec3 mesoNormal = normal;  // Enable for tangent-space normal map\n        vec3 mesoNormal = normalize(normalMatrix * (normalSurface * 2.0 - 1.0));  // For object space normal map\n        vec3 viewerDirection = normalize(vViewPosition);\n        float ndv = max(dot(mesoNormal, viewerDirection), 0.0);\n\n        vec3 totalSpecularLight = vec3(0.0);\n        vec3 totalDiffuseLight = vec3(0.0);\n\n#if NUM_POINT_LIGHTS > 0\n        vec3 pointSpecularColor;\n        vec3 pointDiffuseColor;\n        vec3 pointAmbientColor;\n        float diffuseSurfaceMean = dot(diffuseSurface.rgb, vec3(1.0))/3.0;\n        if (uBrdfModel == 1) {  // [Three.js MR]\n          pointSpecularColor = diffuseSurface.rgb * metallicSurface + 0.04 * (1.0 - metallicSurface);\n          pointDiffuseColor = diffuseSurface.rgb * (1.0 - metallicSurface);\n          // Substance Designer:\n          //pointDiffuseColor = diffuseSurface.rgb * (1.0 - metallicSurface) * (1.0 - pointSpecularColor);\n          pointAmbientColor = ambientLightColor;\n        } else {                // [BIS Disney]]\n          pointSpecularColor = (diffuseSurface.rgb/diffuseSurfaceMean)*tintSurface + (1.0 - tintSurface);\n          pointDiffuseColor = diffuseSurface.rgb * pi; // Convert to physically correct lighting\n          pointAmbientColor = ambientLightColor * pi;  // Convert to physically correct lighting\n        }\n        for (int i = 0; i < NUM_POINT_LIGHTS; i ++) {\n          vec3 lVector = pointLights[i].position + vViewPosition.xyz;\n          lVector = normalize(lVector);\n          vec3 halfVector = normalize(lVector + viewerDirection);\n          float ndh = dot(mesoNormal, halfVector);\n          float ndl = max(dot(mesoNormal, lVector), 0.0);\n\n          float attenuation;\n          float pointSpecularWeight;\n          if (uBrdfModel == 1) {  // [Three.js MR]\n            attenuation = punctualLightIntensityToIrradianceFactor(length(lVector), pointLights[i].distance, pointLights[i].decay);\n            pointSpecularWeight = uSpecular * MRSpecular(uRoughness * roughnessSurface, ndh, ndl, ndv);\n            if (uFresnel) {\n              float vdh = dot(viewerDirection, halfVector);\n              pointSpecularColor = F_Schlick(pointSpecularColor, vdh);\n            }\n          } else {                // [BIS Disney]\n            attenuation = calcLightAttenuation(length(lVector), pointLights[i].distance, pointLights[i].decay);\n            pointSpecularWeight = DisneySpecular(uSpecular*specularSurface, uRoughness*roughnessSurface, ndh, s) / ndl;\n            // FIXME: This assumes the light colour is white or grey.\n            pointSpecularWeight *= pointLights[i].color.r;\n          }\n\n          vec3 irradiance = ndl * attenuation * pointLights[i].color;\n          totalDiffuseLight += pointDiffuseColor * irradiance / pi;\n          totalSpecularLight += pointSpecularWeight * pointSpecularColor * irradiance;\n        }\n        vec3 ambientContrib = pointDiffuseColor * pointAmbientColor / pi;\n#else\n        vec3 ambientContrib = vec3(0.0);\n#endif\n\n        vec3 outgoingLight = white_L * uExposure *\n            (ambientContrib + uDiffuse*totalDiffuseLight + totalSpecularLight);\n\n        gl_FragColor = vec4((uContrast * (outgoingLight * 2.0 - 1.0) + 0.5) + 2.0 * uBrightness - 1.0, 1.0);\n      }\n    }\n  "]);return B=function(){return e},e}function N(){var e=A(["\n    varying vec3 vNormal;\n    varying vec2 vUv;\n    varying vec3 vViewPosition;\n\n    void main() {\n      vec4 worldPosition = modelMatrix*vec4(position, 1.0);\n\n      vUv = uv;\n      // Alternatively this might be needed if we are scaling the texture:\n      // vUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\n      #include <beginnormal_vertex>\n      #include <defaultnormal_vertex>\n\n      vNormal = normalize(transformedNormal);\n\n      #include <begin_vertex>\n      #include <project_vertex>\n\n      vViewPosition = - mvPosition.xyz;\n    }\n    "]);return N=function(){return e},e}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var V=function(e){try{var t,n=function(n,o){try{var i=Promise.resolve(G(e)).then(function(e){return Promise.resolve(JSON.parse(e)).then(function(e){t=e})})}catch(e){return o()}return i&&i.then?i.then(void 0,o):i}(0,function(){t=null});return Promise.resolve(n&&n.then?n.then(function(){return t}):t)}catch(e){return Promise.reject(e)}},G=function(e){try{var t=new Promise(function(t,n){var o=new XMLHttpRequest;o.open("GET",e),o.overrideMimeType("application/json"),o.onload=function(){o.status>=200&&o.status<300?t(o.response):n(o.statusText)},o.onerror=function(){n(o.statusText)},o.send()});return Promise.resolve(t)}catch(e){return Promise.reject(e)}};function q(e,t,n){for(var o in void 0===n&&(n=null),null==n&&(n={lightPosition:THREE.Vector3,lightPositionOffset:THREE.Vector2}),e){var i=n[o];t[o]=null==i?e[o]:(a=e[o],s=i,r=void 0,console.assert(s==THREE.Vector2||s==THREE.Vector3||s==THREE.Color),Array.isArray(a)?(r=new s).fromArray(a):r=a,r)}var a,s,r}function Z(e,t,n){for(var o in e)t[o]=null==n[o]?e[o]:e[o].clone()}var W=function(){function A(a){this.controlModes={FULL:"full",QA:"qa",MANAGE:"manage",NONE:"none"};var s,r=(s=function(e){return e.toString()},{uniforms:e.merge([t.lights,{diffuseMap:{value:null},normalMap:{value:null},specularMap:{value:null},normalScale:{value:new n(1,1)},uExposure:{value:1},uDiffuse:{value:1},uSpecular:{value:1},uRoughness:{value:1},uTint:{value:!0},uFresnel:{value:!1},uBrdfModel:{value:0},uThreeJsShader:{value:!1},uBrdfVersion:{value:2},uLoadExr:{value:!1},uDual8Bit:{value:!1},diffuseMapLow:{value:null},normalMapLow:{value:null},specularMapLow:{value:null},ltc_1:{value:null},ltc_2:{value:null},uBrightness:{value:1},uContrast:{value:.5}}]),vertexShader:s(N()),fragmentShader:s(B())}),l=r.vertexShader,u=r.fragmentShader;if(this.uniforms=r.uniforms,this.vertexShader=l,this.fragmentShader=u,this.opts=O({},{canvasID:"bivot-canvas",overlayID:"bivot-overlay",configPath:"bivot-config.json",renderPath:"bivot-renders.json",texturePath:"textures",config:null,material:null,textures:null,materialSet:null,controlMode:this.controlModes.FULL,useTouch:null,width:0,height:0,state:null,stateLoadCallback:null,setZoomCallback:null},a),this.state={exposure:1,brightness:.5,contrast:.5,focalLength:85,diffuse:1,specular:1,roughness:1,tint:!0,fresnel:!1,ambient:1,fxaa:!0,bloom:.1,adaptiveToneMap:!1,toneMapDarkness:.04,gammaCorrect:!0,threeJsShader:!0,lightType:"point",areaLightWidth:5,areaLightHeight:.2,lightMotion:"mouse",lightColor:[255,255,255],lightPosition:new o(0,0,1),lightPositionOffset:new n(0,0),lightNumber:1,lightSpacing:.5,light45:!1,scan:"kimono 2k",brdfModel:1,brdfVersion:2,yFlip:!0,background:5,backgroundColor:"#050505",meshRotateZDegrees:0,camTiltWithMousePos:0,camTiltWithDeviceOrient:0,camTiltLimitDegrees:0,lightTiltWithMousePos:1,lightTiltWithDeviceOrient:1,lightTiltLimitDegrees:0,tiltDriftSpeed:1,tiltZeroOnMouseOut:!1,portrait:!1,autoRotatePeriodMs:0,autoRotateFps:30,autoRotateCamFactor:.5,autoRotateLightFactor:.9,_camPositionOffset:new n(0,0),_meshRotateZDegreesPrevious:0,_statusText:""},this.config={textureFormat:"EXR",loadExr:void 0,loadPng:void 0,loadJpeg:void 0,dual8Bit:!1,showInterface:!0,mouseCamControlsZoom:!0,mouseCamControlsRotate:!0,mouseCamControlsPan:!0,useTouch:!0,initCamZ:.9,minCamZ:.4,maxCamZ:2,linearFilter:!0,gamma:1.8,initialState:{}},this.opts.state){for(var c in this.state)this.opts.state.hasOwnProperty(c)||(this.opts.state[c]=this.state[c]);this.state=this.opts.state}this.vectorKeys={lightPosition:o,lightPositionOffset:n},Z(this.state,this.config.initialState,this.vectorKeys),this.canvas=document.getElementById(this.opts.canvasID),this.overlay=document.getElementById(this.opts.overlayID),console.assert(null!=this.canvas,"canvas element ID not found:",this.opts.canvasID),console.assert(null!=this.overlay,"overlay div element ID not found:",this.opts.overlayID),this.scans={},this.materials={},this.exposureGain=1e-4,this.renderRequested=!1,this.scene=new i,this.camera=null,this.lights=null,this.lights45=null,this.mesh=null,this.renderer=null,this.fxaaPass=null,this.toneMappingPass=null,this.renderPass=null,this.bloomPass=null,this.gammaCorrectPass=null,this.composer=null,this.controls=null,this.mouseInCanvas=!1,this.shuttingDown=!1,this.timeouts=[],this.listeners=[],this.elements=[]}var I=A.prototype;return I.startRender=function(){var e=this,t=this,o=null,i=null,f=!1,m=window.matchMedia("(pointer: coarse)").matches,d=new n(0,0),g=!1,M=null,C=!1,D=null,T=null,R=null,E=null,_=null,j="undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission,O=null,A=!1,I=null,B=!1,N=null;/iPhone|iPad|iPod/i.test(navigator.userAgent)&&(I=navigator.userAgent.match(/OS [\d_]+/i)[0].substr(3).split("_").map(function(e){return parseInt(e)}),B=12==I[0]&&I[1]>=2);var G=function(){for(var e,t={controls:["full","qa","manage","none"],show:"SAFE_STRING",showcase:["1"],textureFormat:["JPG","PNG","EXR"]},n={},o=k(new URL(window.location.href).searchParams);!(e=o()).done;){var i=e.value,a=i[0],s=decodeURI(i[1]);if(t.hasOwnProperty(a)){var r=t[a];Array.isArray(r)?r.includes(s)?n[a]=s:console.warn("Invalid query parameter value for key:",a):"SAFE_STRING"==r&&(/^[a-zA-Z0-9-_\s]*$/.test(s)?n[a]=s:console.warn("Invalid characters in string value for key:",a))}else console.warn("Invalid keys found in query parameters")}return console.log("URL flags:",n),n}();function W(){T.style.display="none",t.uniforms.diffuseMap.value=D.get("diffuse"),t.uniforms.normalMap.value=D.get("normals"),t.uniforms.specularMap.value=D.get("specular"),t.config.dual8Bit&&(t.uniforms.diffuseMapLow.value=D.get("diffuse_low"),t.uniforms.normalMapLow.value=D.get("normals_low"),t.uniforms.specularMapLow.value=D.get("specular_low"));var e=new p({fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,uniforms:t.uniforms,lights:!0});e.defines={USE_NORMALMAP:1,OBJECTSPACE_NORMALMAP:1},e.extensions.derivatives=!0,t.mesh.traverse(function(t){t instanceof u&&(t.material=e)}),t.scene.add(t.mesh),!O||C||!B&&!j||f||(N=setTimeout(function(){B&&(t.state._statusText="To enable tilt control, please switch on Settings > Safari > Motion & Orientation Access and then reload this page."),Y()},1e3),t.timeouts.push(N),t.registerEventListener(window,"deviceorientation",J)),C=!0,g=!1,t.updateLightingGrid(),t.requestRender()}function z(){t.state.adaptiveToneMap||(t.toneMappingPass.setAdaptive(!1),t.toneMappingPass.setAverageLuminance(t.state.toneMapDarkness))}function U(e){t.opts.setZoomCallback&&t.opts.setZoomCallback(t.camera.position.length()),t.requestRender()}function X(e){(e.alpha||e.beta||e.gamma)&&(f=!0,window.removeEventListener("deviceorientation",X,!1),t.state.lightMotion="gyro",K())}function H(e){"function"==typeof DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission().then(function(e){"granted"===e&&(A=!0,K(),J())}).catch(console.error)}function J(){clearTimeout(N),window.removeEventListener("deviceorientation",J),t.state._statusText="",f&&(A=!0),Y()}function Y(){if(O&&j&&!A){E.style.display="flex";var e=t.registerElement(document,"button");e.className="bivot-button",e.innerHTML="Tap to enable tilt control",e.onclick=H,_.appendChild(e)}else 0==t.state._statusText.length?(E.style.display="none",_.innerHTML=""):(E.style.display="flex",_.innerHTML=t.state._statusText)}function K(){"mouse"==t.state.lightMotion?(window.removeEventListener("deviceorientation",ne,!1),t.registerEventListener(document,"mousemove",$,!1),t.registerEventListener(document,"mouseout",Q,!1),t.registerEventListener(t.canvas,"mouseover",ee,!1),t.registerEventListener(t.canvas,"mouseout",te,!1)):"gyro"==t.state.lightMotion?(t.registerEventListener(window,"deviceorientation",ne,!1),document.removeEventListener("mousemove",$,!1),document.removeEventListener("mouseout",Q,!1),t.canvas.removeEventListener("mouseover",ee,!1),t.canvas.removeEventListener("mouseout",te,!1)):(console.assert("animate"==t.state.lightMotion),window.removeEventListener("deviceorientation",ne,!1),document.removeEventListener("mousemove",$,!1),document.removeEventListener("mouseout",Q,!1),t.canvas.removeEventListener("mouseover",ee,!1),t.canvas.removeEventListener("mouseout",te,!1))}function $(e){e.preventDefault();var o=e.clientX,i=e.clientY;if(t.isViewPortCoordInCanvas(o,i)){var a=t.canvas.getBoundingClientRect(),s=new n((o-a.left)/(a.right-a.left)*2-1,-(i-a.top)/(a.bottom-a.top)*2+1);t.updateCamsAndLightsFromXY(s,t.state.lightTiltWithMousePos,t.state.camTiltWithMousePos)}}function Q(e){t.lights&&t.state.tiltZeroOnMouseOut&&(t.state.lightPosition.set(t.state.lightPositionOffset.x,t.state.lightPositionOffset.y,1),t.state.lightPosition.copy(t.xyTo3dDirection(new n(0,0),t.state.lightPositionOffset,t.state.lightTiltWithMousePos,t.state.lightTiltLimitDegrees)),t.updateLightingGrid()),t.camera&&t.state.tiltZeroOnMouseOut&&0!=t.state.camTiltWithMousePos&&t.camera.position.set(0,0,t.camera.position.length()),!t.state.autoRotatePeriodMs||"mouse"!=t.state.lightMotion&&"animate"!=t.state.lightMotion||t.requestRender()}function ee(e){t.mouseInCanvas=!0}function te(e){t.mouseInCanvas=!1}function ne(e){var o=function(e){var t=window.orientation||0,o=new n;return 0==t||180==t?o.set(e.beta,e.gamma):o.set(e.gamma,e.beta),0==t?o.y=-o.y:90==t?(o.x=-o.x,o.y=-o.y):180==t&&(o.x=-o.x),o}(e);g||(d.copy(o),g=!0);var i=o.clone().sub(d),a=new n(Math.sin(l.degToRad(i.y)),Math.sin(l.degToRad(i.x))),s=Math.max(t.state.camTiltLimitDegrees,t.state.lightTiltLimitDegrees),r=Math.cos(l.degToRad(s));if(a.length()>r){var u=a.length()-a.clone().clampLength(0,r).length();d.addScaledVector(i,u*t.state.tiltDriftSpeed)}t.updateCamsAndLightsFromXY(a,t.state.lightTiltWithDeviceOrient,t.state.camTiltWithDeviceOrient)}function oe(){t.state._meshRotateZDegreesPrevious=0,t.updateMeshRotation()}function ie(e,n,o){if(new L(o).load(n,function(e){console.log("Loaded mesh object:",n),t.mesh=e,oe()},function(e){},function(e){console.log("Mesh unavailable; using planar geometry"),t.mesh=new u(new v(2048/(300/.0254),2048/(300/.0254))),oe()}),D=new Map,t.opts.materialSet)for(var i,a=k(e);!(i=a()).done;){t.config.textureFormat=i.value[1].path.split(".").pop().toUpperCase();break}M="EXR"==t.config.textureFormat?new x(o):new y(o),re(0,0,1),console.log(e);for(var s,r=function(){var e=s.value,n=e[0],o=e[1];M.load(o.path,function(e,i){t.config.linearFilter?"EXR"==t.config.textureFormat?(e.minFilter=w,e.magFilter=w):(e.minFilter=b,e.magFilter=w):(e.minFilter=S,e.magFilter=S),e.name=n,e.flipY=t.state.yFlip==("EXR"==t.config.textureFormat),e.format=o.format,console.log("Loaded:",n,o.path),D.set(n,e)})},l=k(e);!(s=l()).done;)r()}function ae(e,n,o,i){var a=new Map;a.set("diffuse",{path:n.basecolor,format:h}),a.set("normals",{path:n.normals,format:h}),a.set("specular",{path:n.specular,format:h});var s=[],r=o.config.renders[t.state.scan];r.hasOwnProperty("state")&&q(r.state,s,t.vectorKeys),r.hasOwnProperty("version")&&(s.brdfVersion=r.version),se(s,i),ie(a,n.mesh,e)}function se(e,n){var o=[],i=t.scans[t.state.scan];i.hasOwnProperty("cameraPositionX")&&(t.camera.position.x=i.cameraPositionX),i.hasOwnProperty("cameraPositionY")&&(t.camera.position.y=i.cameraPositionY),i.hasOwnProperty("cameraPositionZ")&&(t.camera.position.z=i.cameraPositionZ),i.hasOwnProperty("controlsMinDistance")&&(t.controls.minDistance=i.controlsMinDistance),i.hasOwnProperty("controlsMaxDistance")&&(t.controls.maxDistance=i.controlsMaxDistance),i.hasOwnProperty("state")&&q(i.state,o,t.vectorKeys),i.hasOwnProperty("version")&&(o.brdfVersion=i.version),function(e,t,n,o,i,a){e.forEach(function(e,s){var r=a[e];e in n?null==r?t[e]=n[e]:t[e].copy(n[e]):e in o?null==r?t[e]=o[e]:t[e].copy(o[e]):e in i&&(null==r?t[e]=i[e]:t[e].copy(i[e]))})}(n,t.state,o,e,t.config.initialState,t.vectorKeys),console.log("  BRDF model: ",t.state.brdfModel),console.log("  BRDF version: ",t.state.brdfVersion),t.opts.stateLoadCallback&&t.opts.stateLoadCallback(t.state)}function re(e,t,n){var o=t/n;T.style.display="",R.style.transform="scaleX("+o+")"}Object.values(this.controlModes).indexOf(G.controls)>-1&&(this.opts.controlMode=G.controls),function(){try{var e=function(){function e(){t.scans.hasOwnProperty(t.state.scan)||(t.state.scan=Object.keys(t.scans)[0])}var n=function(){if(!t.scans||function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}(t.scans))return Promise.resolve(function(e,t,n,o,i){try{var a,s=function(){if(e)return Promise.resolve(V(e)).then(function(o){if(o){for(a in console.log("Loaded:",e),o)"initialState"==a?q(o[a],t.initialState,i):t[a]=o[a];Z(t.initialState,n,i)}else console.log("Error: Failed to load "+e)});if(o)for(a in console.log("Using provided config object"),o)"initialState"==a?q(o[a],t.initialState,i):t[a]=o[a]}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}(t.opts.configPath,t.config,t.state,t.opts.config,t.vectorKeys)).then(function(){return Promise.resolve(function(e,t){try{var n={},o=function(){if(e)return Promise.resolve(V(e)).then(function(t){if(t)if(console.log("Loaded "+e+":",t),1==G.showcase)for(var o in t.renders)t.renders.hasOwnProperty(o)&&t.renders[o].showcase>0&&(n[o]=t.renders[o]);else n=t.renders;else console.log("Error: Failed to load "+e)});t&&(console.log("Using provided material object"),n=t.config.renders)}();return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(e){return Promise.reject(e)}}(t.opts.renderPath,t.opts.material)).then(function(e){t.scans=e})})}();return n&&n.then?n.then(e):e()},n=function(){if(t.opts.materialSet)return Promise.resolve(function(e){try{var t,n=function(){return console.log("materialSet loaded: ",o),o};console.log("loadMaterialSet(): Loading material set file:",e);var o={},i=function(){if(e)return Promise.resolve(V(e)).then(function(e){if(e)for(var n=e.materials.length,i=0;i<n;i++){var a=e.materials[i].gallery,s=a[a.length-1],r=s.config.renders[s.name],l={};for(t in s)"config"!=t&&s.hasOwnProperty(t)&&(l[t]=s[t]);l.config={renders:{[s.name]:{state:{}}}};var u=l.config.renders[s.name];for(t in r)"state"!=t&&r.hasOwnProperty(t)&&(u[t]=r[t]);q(r.state,u.state),o[l.name]=l}})}();return Promise.resolve(i&&i.then?i.then(n):n())}catch(e){return Promise.reject(e)}}(t.opts.materialSet)).then(function(e){t.scans=e})}();return Promise.resolve(n&&n.then?n.then(e):e())}catch(e){return Promise.reject(e)}}().then(function(){var n,l,f,d,g,p;G.hasOwnProperty("show")&&(t.state.scan=G.show),G.hasOwnProperty("textureFormat")&&(t.config.textureFormat=G.textureFormat),console.assert((e.config.loadExr||0)+(e.config.loadPng||0)+(e.config.loadJpeg||0)<=1),e.config.loadExr?e.config.textureFormat="EXR":e.config.loadPng?e.config.textureFormat="PNG":e.config.loadJpeg&&(e.config.textureFormat="JPG"),e.config.hasOwnProperty("textureFormat")&&"string"==typeof e.config.textureFormat&&(e.config.textureFormat=e.config.textureFormat.toUpperCase()),console.log("Options:",e.opts),console.log("Config:",e.config),console.log("State:",e.state),console.log("Renders:",e.scans),O=0!=e.state.camTiltWithDeviceOrient||0!=e.state.lightTiltWithDeviceOrient,function(e){var n=t.registerElement(document,"div");n.className+="bivot-loading";var o=t.registerElement(document,"div");o.className+="bivot-progress";var i=t.registerElement(document,"div");i.className+="bivot-progressbar",e.appendChild(n),n.appendChild(o),o.appendChild(i);var a=t.registerElement(document,"div");a.className+="bivot-subtitle";var s=t.registerElement(document,"div");s.className+="bivot-subtitle-background";var r=t.registerElement(document,"p");r.className+="bivot-subtitle-text",e.appendChild(a),a.appendChild(s),s.appendChild(r),T=n,R=i,E=a,_=r}(e.overlay),n=e.getBgColorFromState(e.state),(l=e.scene).background=new a(n),t.updateLightingGrid(),K(),i=new s(4144959,1),l.add(i),e.camera=function(e,t){o=function(e,t){return 2*Math.atan(.024/(2*e/1e3))*180/Math.PI}(e);var n=new r(o,2,.01,10);return n.position.set(0,0,t),n}(e.state.focalLength,e.config.initCamZ),e.controls=(d=e.config,g=e.state.camTiltLimitDegrees,(p=new P(e.camera,e.canvas)).enableDamping=!0,p.dampingFactor=.15,p.panSpeed=.3,p.rotateSpeed=1,p.zoomSpeed=1,p.target.set(0,0,0),p.update(),p.enableZoom=d.mouseCamControlsZoom,p.enableRotate=d.mouseCamControlsRotate,p.enablePan=d.mouseCamControlsPan,p.minDistance=d.minCamZ,p.maxDistance=d.maxCamZ,p.screenSpacePanning=!0,m&&(p.zoomSpeed*=.25,d.useTouch||p.dispose()),function(e,t){var n=Math.PI*t/180;e.minPolarAngle=n,e.maxPolarAngle=Math.PI-n,e.minAzimuthAngle=-Math.PI/2+n,e.maxAzimuthAngle=+Math.PI/2-n}(p,g),t.registerEventListener(p,"change",U),p),e.initialiseCanvas(e.canvas,e.opts.width,e.opts.height),e.renderer=e.initialiseRenderer(),F.init(e.renderer),e.composer=e.initialiseComposer(e.renderer,z),e.updateCanvas(),function(){null!=t.mesh&&(t.scene.remove(t.mesh),t.mesh.traverse(function(e){e instanceof u&&(e.geometry.dispose(),e.material.dispose())}));var e=new c;e.onLoad=W,e.onProgress=re;var n=Object.keys(t.config.initialState);n.push("zoom"),t.opts.materialSet?function(e,t,n){var o={};for(var i in t.textures)o[i]=t.location+"/"+t.textures[i];ae(e,o,t,n)}(e,t.scans[t.state.scan],n):t.opts.textures&&t.opts.material?ae(e,t.opts.textures,t.opts.material,n):function(e,n,o){var i,a,s,r=n+"/render.json";i=r,a=function(i,a){var s=[];if(!i)try{var l=JSON.parse(a);console.log("Loaded metadata from "+r+":",l),l.hasOwnProperty("state")&&q(l.state,s),l.hasOwnProperty("version")&&(s.brdfVersion=l.version)}catch(e){i=1}i&&console.log("Render metadata ("+r+") not loaded: "+i),se(s,o),function(e,n){var o=new Map;1==t.state.brdfModel&&t.state.brdfVersion>=2?(o.set("diffuse","basecolor"),o.set("normals","normals"),o.set("specular","roughness-metallic")):(o.set("diffuse","diffuse"),o.set("normals","normals"),o.set("specular","specular-srt"));var i=new Map;console.assert(["JPG","PNG","EXR"].includes(t.config.textureFormat)),"EXR"==t.config.textureFormat?(i.set("diffuse",{path:n+"/brdf-"+o.get("diffuse")+"_cropf16.exr",format:h}),i.set("normals",{path:n+"/brdf-"+o.get("normals")+"_cropf16.exr",format:h}),i.set("specular",{path:n+"/brdf-"+o.get("specular")+"_cropf16.exr",format:h})):"JPG"==t.config.textureFormat?(i.set("diffuse",{path:n+"/brdf-"+o.get("diffuse")+"_cropu8_hi.jpg",format:h}),i.set("normals",{path:n+"/brdf-"+o.get("normals")+"_cropu8_hi.jpg",format:h}),i.set("specular",{path:n+"/brdf-"+o.get("specular")+"_cropu8_hi.jpg",format:h})):(i.set("diffuse",{path:n+"/brdf-"+o.get("diffuse")+"_cropu8_hi.png",format:h}),i.set("normals",{path:n+"/brdf-"+o.get("normals")+"_cropu8_hi.png",format:h}),i.set("specular",{path:n+"/brdf-"+o.get("specular")+"_cropu8_hi.png",format:h}),t.config.dual8Bit&&(i.set("diffuse_low",{path:n+"/brdf-"+o.get("diffuse")+"_cropu8_lo.png",format:h}),i.set("normals_low",{path:n+"/brdf-"+o.get("normals")+"_cropu8_lo.png",format:h}),i.set("specular_low",{path:n+"/brdf-"+o.get("specular")+"_cropu8_lo.png",format:h}))),ie(i,n+"/brdf-mesh.obj",e)}(e,n)},(s=new XMLHttpRequest).open("GET",i),s.overrideMimeType("application/json"),s.onload=function(){var e=s.status;a(200==e?null:e,s.response)},s.onerror=function(){a(s.status,s.response)},s.send()}(e,t.opts.texturePath+"/"+t.state.scan,n)}(),(f=e.state.zoom)&&(t.state.currentZoom=f[1],t.updateZoom()),O&&e.registerEventListener(window,"deviceorientation",X,!1),e.registerEventListener(window,"resize",e.requestRender),1!=e.opts.useTouch&&0!=e.opts.useTouch||(e.config.useTouch=e.opts.useTouch)})},I.initialiseCanvas=function(e,t,n){var o,i,a=this.overlay;t&&n?(o=t,i=n):(o=a.clientWidth,i=a.clientHeight);var s=window.devicePixelRatio||1;e.width=o*s,e.height=i*s,e.style.width=e.width/s+"px",e.style.height=e.height/s+"px"},I.initialiseRenderer=function(){var e=new f({canvas:this.canvas,preserveDrawingBuffer:!0});return e.physicallyCorrectLights=!0,e.gammaInput=!0,e.gammaOutput=!1,e.gammaFactor=this.config.gamma,e},I.initialiseComposer=function(e,t){var o=new C(e);return this.renderPass=new D(this.scene,this.camera),o.addPass(this.renderPass),this.bloomPass=new R(new n(window.innerWidth,window.innerHeight),this.state.bloom,.4,.99),o.addPass(this.bloomPass),this.fxaaPass=new T(_),this.setFxaaResolution(),o.addPass(this.fxaaPass),this.gammaCorrectPass=new T(j),o.addPass(this.gammaCorrectPass),this.toneMappingPass=new E(!0,256),t(),o.addPass(this.toneMappingPass),o},I.isViewPortCoordInCanvas=function(e,t){if(!this.canvas)return!1;var n=this.canvas.getBoundingClientRect();return e>=n.left&&e<n.right&&t>=n.top&&t<n.bottom},I.updateLightingGrid=function(){this.lights&&this.scene.remove(this.lights),this.lights45&&this.scene.remove(this.lights45);var e=65536*Math.round(.5*this.state.lightColor[0])+256*Math.round(.5*this.state.lightColor[1])+Math.round(.5*this.state.lightColor[2]),t=Math.pow(this.state.lightNumber,2);this.state.light45&&(t*=2);for(var n=1/t*2,i=new o(0,0,this.state.lightPosition.length()),a=new m,s=this.state.lightNumber/2-.5,r=0;r<this.state.lightNumber;r++)for(var l=0;l<this.state.lightNumber;l++){var u=new o((r-s)*this.state.lightSpacing,(l-s)*this.state.lightSpacing,0);if("area"==this.state.lightType){var c=n/(Math.atan(this.state.areaLightWidth)*Math.atan(this.state.areaLightHeight)),h=new d(e,c,this.state.areaLightWidth,this.state.areaLightHeight);h.position.copy(i),h.position.add(u),a.add(h)}else{var f=new g(e,n,10,2);f.position.copy(i),f.position.add(u),a.add(f)}}var p=i.clone();p.normalize();var v=this.state.lightPosition.clone();v.normalize();var y=new o(0,0,0);y.crossVectors(p,v);var w=Math.acos(p.dot(v));if(a.rotateOnAxis(y,w),this.lights=a,this.scene.add(a),this.state.light45){this.lights45=a.clone();var b=new o(1,0,0);this.lights45.rotateOnAxis(b,Math.PI/4),this.scene.add(this.lights45)}else this.lights45=null;this.requestRender()},I.updateCamsAndLightsFromXY=function(e,t,n){if(this.lights&&0!=t&&(this.state.lightPosition.copy(this.xyTo3dDirection(e,this.state.lightPositionOffset,t,this.state.lightTiltLimitDegrees)),this.updateLightingGrid()),this.camera&&0!=n){var o=this.xyTo3dDirection(e,this.state._camPositionOffset,n,this.state.camTiltLimitDegrees);this.camera.position.copy(o.multiplyScalar(this.camera.position.length())),this.requestRender()}},I.xyTo3dDirection=function(e,t,i,a){var s=new n,r=Math.cos(Math.PI*a/180);s.copy(e).add(t).multiplyScalar(i).clampLength(0,r);var l=1-s.lengthSq(),u=0;return l>0&&(u=Math.sqrt(l)),console.assert(!isNaN(u)),new o(s.x,s.y,u)},I.updateMeshRotation=function(){this.mesh&&(this.mesh.rotateZ((this.state.meshRotateZDegrees-this.state._meshRotateZDegreesPrevious)*Math.PI/180),this.state._meshRotateZDegreesPrevious=this.state.meshRotateZDegrees)},I.updateCanvas=function(){if(this.canvas){var e=window.devicePixelRatio||1;this.canvas.style.width=this.canvas.width/e+"px",this.canvas.style.height=this.canvas.height/e+"px",this.renderer.setSize(this.canvas.width,this.canvas.height,!1),this.camera.aspect=this.canvas.width/this.canvas.height,this.camera.updateProjectionMatrix(),this.composer.setSize(this.canvas.width,this.canvas.height),this.setFxaaResolution()}},I.getBgColorFromState=function(e){return e.backgroundColor?parseInt(e.backgroundColor.replace("#","0x")):65793*e.background},I.updateBackground=function(){this.scene.background=new a(this.getBgColorFromState(this.state)),this.requestRender()},I.updateZoom=function(){if(this.controls&&(this.controls.minDistance=this.state.zoom[0],this.controls.maxDistance=this.state.zoom[2]),this.camera){var e=this.state.currentZoom/this.camera.position.length();this.camera.position.copy(this.camera.position.multiplyScalar(e))}this.requestRender()},I.setFxaaResolution=function(){var e=this.fxaaPass.material.uniforms,t=1/this.renderer.getPixelRatio();this.state.fxaa||(t=0),e.resolution.value.x=t/window.innerWidth,e.resolution.value.y=t/window.innerHeight},I.updateAutoRotate=function(e){var t=this;if(!this.mouseInCanvas||"animate"==this.state.lightMotion){var o=2*Math.PI*e,i=new n(-Math.sin(o),Math.cos(o)),a=-.3*this.state.autoRotateCamFactor,s=1*this.state.autoRotateLightFactor;this.timeouts.push(setTimeout(function(){return t.updateCamsAndLightsFromXY(i,s,a)},1e3/this.state.autoRotateFps))}},I.render=function(e){this.shuttingDown?this.doShutdown():this.controls&&this.composer&&(this.state.dirty&&(this.state.dirty=!1,this.updateBackground(),this.updateLightingGrid(),this.updateMeshRotation(),this.updateCanvas(),this.updateZoom()),this.controls.update(),!this.state.autoRotatePeriodMs||"mouse"!=this.state.lightMotion&&"animate"!=this.state.lightMotion||this.updateAutoRotate(e%this.state.autoRotatePeriodMs/this.state.autoRotatePeriodMs),this.uniforms.uExposure.value=this.exposureGain*this.state.exposure,this.uniforms.uBrightness.value=this.state.brightness,this.uniforms.uContrast.value=this.state.contrast,this.uniforms.uDiffuse.value=this.state.diffuse,this.uniforms.uSpecular.value=this.state.specular,this.uniforms.uRoughness.value=this.state.roughness,this.uniforms.uTint.value=this.state.tint,this.uniforms.uFresnel.value=this.state.fresnel,this.uniforms.uThreeJsShader.value=this.state.threeJsShader,this.uniforms.uBrdfModel.value=this.state.brdfModel,this.uniforms.uBrdfVersion.value=this.state.brdfVersion,this.uniforms.uLoadExr.value="EXR"==this.config.textureFormat,this.uniforms.uDual8Bit.value=this.config.dual8Bit,this.uniforms.ltc_1.value=t.LTC_1,this.uniforms.ltc_2.value=t.LTC_2,this.composer.render(),this.renderRequested=!1)},I.requestRender=function(){!this.renderRequested&&this.render&&(this.renderRequested=!0,requestAnimationFrame(this.render.bind(this)))},I.checkWebGL=function(){!1===M.isWebGLAvailable()&&document.body.appendChild(M.getWebGLErrorMessage())},I.registerEventListener=function(e,t,n){for(var o=arguments.length,i=new Array(o>3?o-3:0),a=3;a<o;a++)i[a-3]=arguments[a];e.addEventListener.apply(e,[t,n].concat(i)),this.listeners.push({object:e,type:t,listener:n})},I.registerElement=function(e,t){var n=e.createElement(t);return this.elements.push(n),n},I.shutdown=function(){this.shuttingDown=!0},I.doShutdown=function(){for(var e=0;e<this.timeouts.length;e++)clearTimeout(this.timeouts[e]);for(this.timeouts=[],e=0;e<this.listeners.length;e++){var t=this.listeners[e];t.object.removeEventListener(t.type,t.listener)}for(this.listeners=[],e=0;e<this.elements.length;e++){var n=this.elements[e];n.parentNode.removeChild(n)}this.elements=[],this.canvas=null,this.overlay=null},A}();function z(e){return new W(e)}export{z as newBivot};
